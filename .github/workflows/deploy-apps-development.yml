name: 'CI/CD: Build & Deploy to EC2'

on:
  push:
    branches: [develop, feature/#154-multi-arch-support]
    paths:
      - 'apps/**'
      - 'admin/**'
      - '.github/workflows/**'
      - 'docker-compose.yml'
      - 'package.json'
      - 'yarn.lock'

permissions:
  id-token: write
  contents: read

env:
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-apps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names users-app 2>/dev/null || \
          aws ecr create-repository --repository-name users-app

      # ğŸ†• Multi-platform ì§€ì›ì„ ìœ„í•œ QEMU ì„¤ì •
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # ğŸ†• Advanced Buildx ì„¤ì •
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64
          driver-opts: |
            network=host

      # ğŸ†• Next.js Multi-architecture ë¹Œë“œ (SSR ê³ ë ¤)
      - name: Build and Push users-app (Next.js Multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64  # ğŸ¯ SSR ëŸ°íƒ€ì„ ì•„í‚¤í…ì²˜ ì¤‘ìš”
          tags: ${{ env.ECR_REGISTRY }}/users-app:latest
          cache-from: type=gha,scope=users-app
          cache-to: type=gha,mode=max,scope=users-app
          # ğŸ†• Next.js íŠ¹í™” ìµœì í™”
          provenance: false  # Next.js ë¹Œë“œ ì†ë„ í–¥ìƒ
          build-args: |
            BUILDPLATFORM=${{ runner.arch }}
            NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            NEXT_PUBLIC_GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
            NEXT_PUBLIC_GOOGLE_RESPONSE_TYPE=${{ secrets.GOOGLE_RESPONSE_TYPE }}
            NEXT_PUBLIC_GOOGLE_SCOPE=${{ secrets.GOOGLE_SCOPE }}
            NEXT_PUBLIC_GOOGLE_AUTH_URL=${{ secrets.GOOGLE_AUTH_URL }}

  build-admin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names admin-app 2>/dev/null || \
          aws ecr create-repository --repository-name admin-app

      # ğŸ†• Multi-platform ì§€ì›
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      # ğŸ†• React SPA Multi-architecture ë¹Œë“œ (ì •ì  íŒŒì¼ ì¤‘ì‹¬)
      - name: Build and Push admin-app (React Multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: admin/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64  # ğŸ¯ SPAëŠ” ìƒëŒ€ì ìœ¼ë¡œ ì•„í‚¤í…ì²˜ ì˜í–¥ ì ìŒ
          tags: ${{ env.ECR_REGISTRY }}/admin-app:latest
          cache-from: type=gha,scope=admin-app
          cache-to: type=gha,mode=max,scope=admin-app
          # ğŸ†• React íŠ¹í™” ìµœì í™”
          provenance: false
          build-args: |
            BUILDPLATFORM=${{ runner.arch }}

  # ğŸ†• EC2 ì¸ìŠ¤í„´ìŠ¤ ì•„í‚¤í…ì²˜ ê°ì§€ ì‘ì—… ì¶”ê°€
  detect-architecture:
    runs-on: ubuntu-latest
    outputs:
      architecture: ${{ steps.detect.outputs.architecture }}
    steps:
      - name: Detect EC2 Architecture
        id: detect
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) echo "architecture=amd64" >> $GITHUB_OUTPUT ;;
              aarch64|arm64) echo "architecture=arm64" >> $GITHUB_OUTPUT ;;
              *) echo "architecture=amd64" >> $GITHUB_OUTPUT ;;  # ê¸°ë³¸ê°’
            esac
            echo "Detected architecture: $ARCH"

  prepare-deploy:
    runs-on: ubuntu-latest
    needs: [build-apps, build-admin, detect-architecture]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare deployment files
        run: |
          # .env íŒŒì¼ ìƒì„±
          cat > .env << EOF
          KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
          ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          NODE_ENV=production
          TARGET_ARCH=${{ needs.detect-architecture.outputs.architecture }}
          EOF

      - name: Prepare EC2 deployment directory
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ì¤€ë¹„
            sudo rm -rf /home/ubuntu/apps/client
            mkdir -p /home/ubuntu/apps/client
            sudo chown -R ubuntu:ubuntu /home/ubuntu/apps/client
            
            # ğŸ†• ì•„í‚¤í…ì²˜ë³„ Docker ì„¤ì • í™•ì¸
            echo "ğŸ” ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜: $(uname -m)"
            echo "ğŸ³ Docker ë²„ì „: $(docker --version)"
            
            # Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ì¡°ê±´ë¶€)
            DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ $(date +%u) -eq 1 ] || [ $DISK_USAGE -gt 80 ]; then
              echo "ğŸ§¹ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
              docker system prune -af --volumes
            fi

      - name: Copy deployment files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: 'docker-compose.yml,.env'
          target: ~/apps/client

  # ğŸ†• ë°°í¬ ìµœì í™”: ì•±ë³„ íŠ¹ì„± ê³ ë ¤í•œ ìŠ¤ë§ˆíŠ¸ ë°°í¬
  deploy:
    runs-on: ubuntu-latest
    needs: [prepare-deploy, detect-architecture]
    strategy:
      matrix:
        include:
          - image: users-app
            service: users-app
            port: 3000
            type: nextjs
            health_path: "/api/health"  # Next.js API í—¬ìŠ¤ì²´í¬
            timeout: 60  # SSR ì´ˆê¸°í™” ì‹œê°„ ê³ ë ¤
          - image: admin-app
            service: admin-app
            port: 3001
            type: react-spa
            health_path: "/"  # React SPA ë©”ì¸ í˜ì´ì§€
            timeout: 30  # ì •ì  íŒŒì¼ì´ë¯€ë¡œ ë¹ ë¥¸ ì‹œì‘
      max-parallel: 2  # ğŸš€ ë³‘ë ¬ ë°°í¬ë¡œ ì†ë„ í–¥ìƒ

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # ğŸ†• ë°°í¬ ì „ í˜„ì¬ ë²„ì „ ë°±ì—…
      - name: Backup current version
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/apps/client
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€ íƒœê·¸ ë°±ì—…
            CURRENT_IMAGE=$(docker inspect ${{ matrix.service }} --format='{{.Config.Image}}' 2>/dev/null || echo "none")
            echo "BACKUP_IMAGE=$CURRENT_IMAGE" > ~/.${{ matrix.service }}.backup
            echo "ğŸ“¦ ë°±ì—…ëœ ì´ë¯¸ì§€: $CURRENT_IMAGE"

      # ğŸ†• ì•± íŠ¹ì„±ë³„ ìµœì í™”ëœ ë°°í¬
      - name: Deploy with zero-downtime strategy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/apps/client

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            set -a && source .env && set +a

            echo "ğŸš€ ë°°í¬ ì‹œì‘: ${{ matrix.service }} (${{ matrix.type }})"
            echo "ğŸ—ï¸  ëŒ€ìƒ ì•„í‚¤í…ì²˜: ${{ needs.detect-architecture.outputs.architecture }}"

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin $ECR_REGISTRY

            # ğŸ†• Zero-downtime ë°°í¬ ì „ëµ
            if [ "${{ matrix.type }}" = "nextjs" ]; then
              echo "ğŸ“± Next.js ì•± ë°°í¬ - SSR ê³ ë ¤í•œ ì „ëµ"
            
              # 1. ìƒˆ ì´ë¯¸ì§€ í’€
              docker pull $ECR_REGISTRY/${{ matrix.image }}:latest
            
              # 2. í—¬ìŠ¤ì²´í¬ìš© ì„ì‹œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
              docker run -d --name ${{ matrix.service }}-new \
                --network client_default \
                -e NODE_ENV=production \
                $ECR_REGISTRY/${{ matrix.image }}:latest
            
              # 3. í—¬ìŠ¤ì²´í¬ (SSR ì´ˆê¸°í™” ëŒ€ê¸°)
              echo "ğŸ¥ Next.js SSR í—¬ìŠ¤ì²´í¬..."
              for i in {1..12}; do  # 60ì´ˆ ëŒ€ê¸°
                if docker exec ${{ matrix.service }}-new curl -f -s http://localhost:3000${{ matrix.health_path }} > /dev/null 2>&1; then
                  echo "âœ… Next.js SSR ì •ìƒ ì´ˆê¸°í™”"
                  break
                else
                  echo "â³ SSR ì´ˆê¸°í™” ëŒ€ê¸°... ($i/12)"
                  sleep 5
                fi
              done
            
              # 4. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ êµì²´
              docker compose down ${{ matrix.service }} 2>/dev/null || true
              docker rm -f ${{ matrix.service }}-new
              docker compose up -d ${{ matrix.service }}
            
            else
              echo "âš›ï¸  React SPA ë°°í¬ - ë¹ ë¥¸ ì •ì  íŒŒì¼ ì „ëµ"
            
              # React SPAëŠ” ë” ê°„ë‹¨í•œ ë°°í¬
              docker pull $ECR_REGISTRY/${{ matrix.image }}:latest
              docker compose down ${{ matrix.service }} 2>/dev/null || true
              docker compose up -d ${{ matrix.service }}
            fi

            # ğŸ†• ì´ë¯¸ì§€ ì•„í‚¤í…ì²˜ ë° ì •ë³´ í™•ì¸
            echo "ğŸ” ë°°í¬ëœ ì´ë¯¸ì§€ ì •ë³´:"
            docker inspect $ECR_REGISTRY/${{ matrix.image }}:latest --format='{{.Architecture}} {{.Os}}'
            docker inspect $ECR_REGISTRY/${{ matrix.image }}:latest --format='{{.RepoTags}} {{.Created}}'

      # ğŸ†• ì•±ë³„ ë§ì¶¤ í—¬ìŠ¤ì²´í¬
      - name: Advanced health check
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/apps/client
            
            echo "ğŸ¥ ${{ matrix.type }} ë§ì¶¤ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if ! docker compose ps ${{ matrix.service }} | grep -q "Up"; then
              echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
              exit 1
            fi
            
            # ì•± íƒ€ì…ë³„ í—¬ìŠ¤ì²´í¬
            if [ "${{ matrix.type }}" = "nextjs" ]; then
              echo "ğŸ“± Next.js ì „ìš© í—¬ìŠ¤ì²´í¬..."
            
              # 1. API ë¼ìš°íŠ¸ ì²´í¬
              for i in {1..6}; do
                if curl -f -s http://localhost:${{ matrix.port }}${{ matrix.health_path }} | grep -q "ok\|success\|healthy" 2>/dev/null; then
                  echo "âœ… Next.js API ë¼ìš°íŠ¸ ì •ìƒ"
                  break
                elif [ $i -eq 6 ]; then
                  echo "âŒ Next.js API ë¼ìš°íŠ¸ ì‘ë‹µ ì—†ìŒ"
                  exit 1
                else
                  echo "â³ Next.js API ëŒ€ê¸°... ($i/6)"
                  sleep 10
                fi
              done
            
              # 2. SSR í˜ì´ì§€ ë Œë”ë§ ì²´í¬
              if curl -s http://localhost:${{ matrix.port }}/ | grep -q "<html\|<!DOCTYPE" ; then
                echo "âœ… Next.js SSR í˜ì´ì§€ ë Œë”ë§ ì •ìƒ"
              else
                echo "âŒ Next.js SSR ë Œë”ë§ ì‹¤íŒ¨"
                exit 1
              fi
            
            else
              echo "âš›ï¸  React SPA ì „ìš© í—¬ìŠ¤ì²´í¬..."
            
              # React SPAëŠ” ì •ì  íŒŒì¼ ì„œë¹™ í™•ì¸
              for i in {1..3}; do
                if curl -f -s http://localhost:${{ matrix.port }}${{ matrix.health_path }} | grep -q "<div id=\"root\"\|<div id=\"app\"" ; then
                  echo "âœ… React SPA ì •ìƒ ë¡œë“œ"
                  break
                elif [ $i -eq 3 ]; then
                  echo "âŒ React SPA ë¡œë“œ ì‹¤íŒ¨"
                  exit 1
                else
                  echo "â³ React SPA ë¡œë“œ ëŒ€ê¸°... ($i/3)"
                  sleep 5
                fi
              done
            fi
            
            echo "ğŸ‰ ${{ matrix.service }} (${{ matrix.type }}) ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"

      # ğŸ†• ë°°í¬ ì‹¤íŒ¨ ì‹œ ìë™ ë¡¤ë°±
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/apps/client
            
            echo "ğŸ”„ ë°°í¬ ì‹¤íŒ¨ - ë¡¤ë°± ì‹œì‘..."
            
            # ë°±ì—…ëœ ì´ë¯¸ì§€ ë³µêµ¬
            if [ -f ~/.${{ matrix.service }}.backup ]; then
              source ~/.${{ matrix.service }}.backup
              if [ "$BACKUP_IMAGE" != "none" ]; then
                echo "ğŸ“¦ ë¡¤ë°±: $BACKUP_IMAGE"
                docker tag $BACKUP_IMAGE $ECR_REGISTRY/${{ matrix.image }}:rollback
                docker compose down ${{ matrix.service }}
                docker compose up -d ${{ matrix.service }}
                echo "âœ… ë¡¤ë°± ì™„ë£Œ"
              else
                echo "âš ï¸ ë°±ì—… ì´ë¯¸ì§€ ì—†ìŒ - ìˆ˜ë™ ë³µêµ¬ í•„ìš”"
              fi
            fi

  # ğŸ†• ë°°í¬ í›„ í†µí•© ê²€ì¦
  post-deploy-validation:
    runs-on: ubuntu-latest
    needs: [deploy]
    steps:
      - name: Integration test
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: 54.180.126.213
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ” í†µí•© ê²€ì¦ ì‹œì‘..."
            
            # ì „ì²´ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            docker compose ps
            
            # í¬íŠ¸ë³„ ì‘ë‹µ í™•ì¸
            echo "ğŸ“± Next.js ì•± (3000): $(curl -o /dev/null -s -w "%{http_code}" http://localhost:3000)"
            echo "âš›ï¸  React ì•± (3001): $(curl -o /dev/null -s -w "%{http_code}" http://localhost:3001)"
            
            # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
            echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            
            echo "ğŸŠ ì „ì²´ ë°°í¬ ê²€ì¦ ì™„ë£Œ!"