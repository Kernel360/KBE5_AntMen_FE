name: 'CI/CD: Build & Deploy to EC2'

on:
  push:
    branches: [develop]
    paths:
      - 'apps/**'
      - 'admin/**'
      - '.github/workflows/**'
      - 'docker-compose.yml'
      - 'package.json'
      - 'yarn.lock'

permissions:
  id-token: write
  contents: read

env:
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: users-app
            dockerfile: apps/Dockerfile
            image: users-app
            repository: users-app
            needs_env: true
          - name: admin-app
            dockerfile: admin/Dockerfile
            image: admin-app
            repository: admin-app
            needs_env: false

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --prefer-offline

      - name: Build workspace
        run: |
          if [ "${{ matrix.name }}" = "users-app" ]; then
            yarn workspace apps build
          else
            CI=false yarn workspace admin build
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names ${{ matrix.repository }} 2>/dev/null || \
          aws ecr create-repository --repository-name ${{ matrix.repository }}

      - name: Build and Push Docker image
        run: |
          # Docker ê¸°ë³¸ ë¹Œë”ë¡œ ì„¤ì • (Buildx ë¹„í™œì„±í™”)
          export DOCKER_BUILDKIT=0
          
          # í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•œ ê²½ìš°ì™€ ì•„ë‹Œ ê²½ìš° ë¶„ë¦¬
          if [ "${{ matrix.needs_env }}" = "true" ]; then
            docker build -f ${{ matrix.dockerfile }} --build-arg NEXT_PUBLIC_GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} --build-arg NEXT_PUBLIC_GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }} --build-arg NEXT_PUBLIC_GOOGLE_RESPONSE_TYPE=${{ secrets.GOOGLE_RESPONSE_TYPE }} --build-arg NEXT_PUBLIC_GOOGLE_SCOPE=${{ secrets.GOOGLE_SCOPE }} --build-arg NEXT_PUBLIC_GOOGLE_AUTH_URL=${{ secrets.GOOGLE_AUTH_URL }} -t $ECR_REGISTRY/${{ matrix.image }}:latest .
          else
            docker build -f ${{ matrix.dockerfile }} -t $ECR_REGISTRY/${{ matrix.image }}:latest .
          fi
          
          docker push $ECR_REGISTRY/${{ matrix.image }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    strategy:
      matrix:
        include:
          - image: users-app
          - image: admin-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare deployment files
        run: |
          # .env íŒŒì¼ ìƒì„±
          cat > .env << EOF
          KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}
          ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
          NODE_ENV=production
          EOF

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            sudo rm -rf /home/ubuntu/apps/client
            mkdir -p /home/ubuntu/apps/client
            sudo chown -R ubuntu:ubuntu /home/ubuntu/apps/client

      - name: Copy deployment files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: 'docker-compose.yml,.env'
          target: ~/apps/client

      - name: Deploy and restart containers
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            cd ~/apps/client

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            set -a && source .env && set +a

            # ë¡œê·¸ ë° ìƒíƒœ ì¶œë ¥
            echo "ğŸš€ Deploying ${{ matrix.image }}"
            echo "ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸:"
            df -h / | head -2
            docker system df

            # Docker ì •ë¦¬ (ì£¼ê°„ 1íšŒ ë˜ëŠ” í•„ìš”ì‹œ)
            if [ $(date +%u) -eq 1 ] || [ $(df / | tail -1 | awk '{print $5}' | sed 's/%//') -gt 80 ]; then
              echo "ğŸ§¹ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì¤‘..."
              docker system prune -af --volumes
            fi

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin $ECR_REGISTRY

            # ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            echo "ğŸ“¦ ì´ë¯¸ì§€ í’€ë§: ${{ matrix.image }}"
            docker pull $ECR_REGISTRY/${{ matrix.image }}:latest

            echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘: ${{ matrix.image }}"
            docker compose down ${{ matrix.image }} 2>/dev/null || true
            docker compose up -d ${{ matrix.image }}

            # ë°°í¬ ìƒíƒœ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ í™•ì¸:"
            sleep 5
            docker compose ps ${{ matrix.image }}
            docker compose logs --tail=10 ${{ matrix.image }}

            echo "ğŸ‰ ${{ matrix.image }} ë°°í¬ ì™„ë£Œ!"