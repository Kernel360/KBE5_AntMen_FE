# ìµœì¢… ìµœì í™”ëœ admin React ì•± Dockerfile
# ì™¸ë¶€ nginx ì‚¬ìš©, ì»¨í…Œì´ë„ˆëŠ” ì •ì  íŒŒì¼ë§Œ ì„œë¹™

# ë¹Œë“œ ë‹¨ê³„
FROM --platform=$BUILDPLATFORM node:20.11-alpine AS builder
ARG TARGETPLATFORM
ARG BUILDPLATFORM

# ğŸš€ ARM64 ìµœì í™” - Canvas ë¹Œë“œë¥¼ ìœ„í•œ ë„êµ¬ ì„¤ì¹˜
RUN apk add --no-cache \
    libc6-compat \
    python3 \
    make \
    g++

WORKDIR /app

# 1. package.json íŒŒì¼ë“¤ ë³µì‚¬ (ìµœì  ìºì‹±)
COPY package.json yarn.lock ./
COPY admin/package.json ./admin/
COPY packages/ui/package.json ./packages/ui/

# 2. apps workspace ë”ë¯¸ ìƒì„± (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì˜¤ë¥˜ ë°©ì§€)
RUN mkdir -p apps && \
    echo '{"name": "apps", "private": true, "version": "1.0.0"}' > apps/package.json

# 3. ğŸ¯ ARM64 ìµœì í™”ëœ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV PYTHON=/usr/bin/python3
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV npm_config_build_from_source=true

# ğŸš€ ARM64 yarn ìµœì í™”
RUN if [ "$TARGETPLATFORM" = "linux/arm64" ]; then \
        yarn config set network-timeout 600000 && \
        yarn config set network-concurrency 8; \
    fi

# 4. ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ ìµœì í™”)
RUN yarn install --frozen-lockfile --network-timeout 300000

# 5. ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (í•„ìš”í•œ ê²ƒë§Œ)
COPY admin/ ./admin/
COPY packages/ui/ ./packages/ui/

# 6. ë¹Œë“œ ì‹¤í–‰
WORKDIR /app/admin
ENV NODE_ENV=production
ENV GENERATE_SOURCEMAP=false
ENV CI=false
ENV SKIP_PREFLIGHT_CHECK=true

RUN yarn build

# í”„ë¡œë•ì…˜ ë‹¨ê³„ - serve ì‚¬ìš© (ì™¸ë¶€ nginxì™€ ì—°ë™)
FROM node:20.11-alpine AS runner

# serve íŒ¨í‚¤ì§€ ì „ì—­ ì„¤ì¹˜
RUN npm install -g serve@14 && \
    addgroup -g 1001 -S nodejs && \
    adduser -S react -u 1001

USER react

WORKDIR /app

# ë¹Œë“œëœ íŒŒì¼ë§Œ ë³µì‚¬
COPY --from=builder --chown=react:nodejs /app/admin/build ./build

EXPOSE 3001

# serveë¡œ ì •ì  íŒŒì¼ ì„œë¹™ (ì™¸ë¶€ nginxê°€ í”„ë¡ì‹œ)
CMD ["serve", "-s", "build", "-l", "3001", "--no-clipboard", "--single"]