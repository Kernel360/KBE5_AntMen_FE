# admin/Dockerfile - íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ìˆ˜ì •
# ğŸš€ ULTRA FAST ADMIN VERSION - @antmen/ui ë¬¸ì œ í•´ê²°

FROM --platform=$BUILDPLATFORM node:20.11-alpine AS builder
ARG TARGETPLATFORM
ARG BUILDPLATFORM

# ëª¨ë“  ë„êµ¬ í•œë²ˆì— ì„¤ì¹˜ (Canvas ë¹Œë“œ í¬í•¨)
RUN apk add --no-cache libc6-compat python3 make g++ curl

WORKDIR /app

# ğŸ”§ 1. ROOT íŒ¨í‚¤ì§€ íŒŒì¼ë“¤ ë¨¼ì € ë³µì‚¬
COPY package.json yarn.lock ./

# ğŸ”§ 2. ëª¨ë“  ì›Œí¬ìŠ¤í˜ì´ìŠ¤ package.json ë³µì‚¬
COPY admin/package.json ./admin/
COPY apps/package.json ./apps/
COPY packages/ui/package.json ./packages/ui/ 2>/dev/null || echo '{"name": "@antmen/ui", "version": "0.0.0"}' > ./packages/ui/package.json

# ğŸ”§ 3. @antmen/ui ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ (ì˜ì¡´ì„± í•´ê²°ì„ ìœ„í•´ ë¨¼ì €)
COPY packages/ui/ ./packages/ui/ 2>/dev/null || mkdir -p ./packages/ui

# ğŸš€ ë³‘ë ¬ ì„¤ì¹˜ ìµœì í™” (ë©”ëª¨ë¦¬ 8GB, ë™ì‹œì„± 16)
ENV NODE_OPTIONS="--max-old-space-size=8192" \
    npm_config_build_from_source=true \
    PYTHON=/usr/bin/python3 \
    YARN_NETWORK_TIMEOUT=180000

# ğŸ”§ ARM64 yarn ìµœì í™” (prefer-offline ì œê±° - ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°)
RUN yarn config set network-concurrency 16 && \
    yarn config set network-timeout 180000 && \
    yarn install --frozen-lockfile

# ğŸ”§ 4. ë‚˜ë¨¸ì§€ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY admin/ ./admin/

# ğŸš€ ë¹ ë¥¸ ë¹Œë“œ (ì†ŒìŠ¤ë§µ ë¹„í™œì„±í™”, ë³‘ë ¬ ì²˜ë¦¬)
WORKDIR /app/admin
ENV NODE_ENV=production \
    GENERATE_SOURCEMAP=false \
    CI=false \
    SKIP_PREFLIGHT_CHECK=true \
    FAST_REFRESH=false

RUN yarn build

# ëŸ°íƒ€ì„ (ì´ˆê²½ëŸ‰í™”)
FROM node:20.11-alpine AS runner

# í•œë²ˆì— ì„¤ì¹˜ (serve + curl + ì‚¬ìš©ì)
RUN npm install -g serve@14 && \
    apk add --no-cache curl && \
    addgroup -g 1001 -S nodejs && \
    adduser -S react -u 1001

USER react
WORKDIR /app

# ë¹Œë“œ ê²°ê³¼ë§Œ ë³µì‚¬
COPY --from=builder --chown=react:nodejs /app/admin/build ./build

EXPOSE 3001

# serveë¡œ ì •ì  íŒŒì¼ ì„œë¹™
CMD ["serve", "-s", "build", "-l", "3001", "--no-clipboard", "--single"]