# admin/Dockerfile - 30ì´ˆ ì´ë‚´ ë¹Œë“œ ìµœì í™”
# ğŸš€ ULTRA FAST ADMIN VERSION - ëª©í‘œ: 30ì´ˆ ì´ë‚´

FROM --platform=$BUILDPLATFORM node:20.11-alpine AS builder
ARG TARGETPLATFORM
ARG BUILDPLATFORM

# ëª¨ë“  ë„êµ¬ í•œë²ˆì— ì„¤ì¹˜ (Canvas ë¹Œë“œ í¬í•¨)
RUN apk add --no-cache libc6-compat python3 make g++ curl

WORKDIR /app

# ìºì‹œ ì¹œí™”ì  ë³µì‚¬ (package.jsonë§Œ ë¨¼ì €)
COPY package.json yarn.lock ./
COPY admin/package.json ./admin/

# ğŸš€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìµœì í™” (ë”ë¯¸ ìƒì„±ìœ¼ë¡œ ì—ëŸ¬ ë°©ì§€)
RUN mkdir -p apps packages/ui && \
    echo '{"name": "apps", "private": true, "version": "1.0.0"}' > apps/package.json && \
    echo '{"name": "@repo/ui", "version": "0.0.0", "main": "index.js"}' > packages/ui/package.json && \
    echo 'module.exports = {};' > packages/ui/index.js

# ğŸš€ ë³‘ë ¬ ì„¤ì¹˜ ìµœì í™” (ë©”ëª¨ë¦¬ 8GB, ë™ì‹œì„± 16)
ENV NODE_OPTIONS="--max-old-space-size=8192" \
    npm_config_build_from_source=true \
    PYTHON=/usr/bin/python3 \
    YARN_NETWORK_TIMEOUT=180000

RUN yarn config set network-concurrency 16 && \
    yarn config set network-timeout 180000 && \
    yarn config set prefer-offline true && \
    yarn install --frozen-lockfile --prefer-offline

# ì†ŒìŠ¤ ë³µì‚¬ (í•„ìš”í•œ ê²ƒë§Œ)
COPY admin/ ./admin/
RUN if [ -d "./packages/ui" ]; then COPY packages/ui/ ./packages/ui/; fi

# ğŸš€ ë¹ ë¥¸ ë¹Œë“œ (ì†ŒìŠ¤ë§µ ë¹„í™œì„±í™”, ë³‘ë ¬ ì²˜ë¦¬)
WORKDIR /app/admin
ENV NODE_ENV=production \
    GENERATE_SOURCEMAP=false \
    CI=false \
    SKIP_PREFLIGHT_CHECK=true \
    FAST_REFRESH=false

RUN yarn build

# ëŸ°íƒ€ì„ (ì´ˆê²½ëŸ‰í™”)
FROM node:20.11-alpine AS runner

# í•œë²ˆì— ì„¤ì¹˜ (serve + curl + ì‚¬ìš©ì)
RUN npm install -g serve@14 && \
    apk add --no-cache curl && \
    addgroup -g 1001 -S nodejs && \
    adduser -S react -u 1001

USER react
WORKDIR /app

# ë¹Œë“œ ê²°ê³¼ë§Œ ë³µì‚¬
COPY --from=builder --chown=react:nodejs /app/admin/build ./build

EXPOSE 3001

# serveë¡œ ì •ì  íŒŒì¼ ì„œë¹™
CMD ["serve", "-s", "build", "-l", "3001", "--no-clipboard", "--single"]